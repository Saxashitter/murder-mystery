name: Makefile CI

on:
  push:
    branches: [ "main", "indev" ]
  pull_request:
    branches: [ "main", "indev" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Update version.lua
      run: |
        rm src/Lua/version.lua
        printf "local commit_sha = \"${{ github.sha }}\"\n\nreturn commit_sha" > src/Lua/version.lua

    - name: Set up build vars
      run: |
        echo "BUILD_HASH=$(git rev-parse --short=7 HEAD)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(git rev-parse --abbrev-ref HEAD)-$(date +%Y-%m-%d)" >> $GITHUB_ENV
        options=("1329261667640541325" "1328478475459236041" "1332171698610507866")
        echo "EMOJI_LOL=${options[$RANDOM % 3]}" >> $GITHUB_ENV
        options=("build time baby" "this build won't be a mystery" "murder :)")
        echo "NAME_LOL=${options[$RANDOM % 3]}" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get install -y nodejs
        sudo npm install argparse
        sudo npm install deasync
        sudo npm install jimp
        sudo npm install jszip
        git clone https://github.com/UnmatchedBracket/PaK3.git

    - name: Make build
      run: |
        mkdir build
        node PaK3/main.js src/ build/EPICMM-${{ env.BUILD_DATE }}.pk3

    - name: Upload build to Actions
      uses: actions/upload-artifact@v4
      with:
        name: EPICMurderMystery
        path: build/EPICMM-${{ env.BUILD_DATE }}.pk3

    - name: Upload build to Litterbox
      run: |
        cd build
        curl -F "reqtype=fileupload" -F "time=72h" -F "fileToUpload=@EPICMM-${{ env.BUILD_DATE }}.pk3" https://litterbox.catbox.moe/resources/internals/api.php > upload.txt
        echo "CATBOX_URL=$(cat upload.txt)" >> $GITHUB_ENV
        cat upload.txt

    - name: Send card to Discord
      uses: stegzilla/discord-notify@v4
      with:
        webhook_url: ${{ secrets.DISCORD_WEBHOOK }}

        title: "Build: ${{ env.BUILD_DATE }}"

        message: "Built off commit [${{ env.BUILD_SHASH }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n[.pk3 link (lasts 3 days)](${{ env.CATBOX_URL }})" # default is 

        avatar_url: "https://cdn.discordapp.com/emojis/${{ env.EMOJI_LOL }}.webp?size=96" # optional, default is 

        username: ${{ env.NAME_LOL }} # optional, default is GitHub

        colour: "#00ff99" # optional, default is #3371FF
